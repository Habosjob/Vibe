# IMPROVEMENTS

## Реализовано (пункты 1-5)
1. ✅ **Доменное разделение pipeline-слоёв (ingest/details/export/dq) в кодовой структуре вызовов и сервисных entrypoint'ов**.
   - Профит: ниже связность, легче точечно оптимизировать этапы и разбирать инциденты.
2. ✅ **Тяжёлые merge/normalize шаги переведены на более экономную обработку с прогрессом и диагностикой**.
   - Профит: меньше «слепых зон» по времени, лучше контроль CPU-bound участков и стабильнее память.
3. ✅ **`bonds_read_model` обновляется инкрементально (upsert/cleanup по SECID), без полного drop/create на каждом прогоне**.
   - Профит: быстрее 4-й этап и меньше write-amplification в SQLite.
4. ✅ **Retention/архивация в SQLite**:
   - `details_cache/details_rows` по TTL,
   - `endpoint_health_history` по дням,
   - `intraday_quotes_snapshot` и `bonds_enriched_incremental` по retention-политикам.
   - Профит: контролируемый рост БД и предсказуемое время обслуживания.
5. ✅ **Профили запуска `--profile full|incremental|offline`**.
   - Профит: детерминированный режим работы для cron и эксплуатации.

## Решение по БД (без отдельного развёртывания)
Принято решение **оставаться на embedded SQLite**, но с агрессивной оптимизацией runtime-параметров:
- `WAL`, `synchronous=NORMAL`, `temp_store=MEMORY`, `mmap_size`,
- регулярные `ANALYZE` и `PRAGMA optimize`,
- retention-политики по «тяжёлым» таблицам.

Плюс: пользователю **не нужно поднимать отдельный сервер БД** и сопровождать дополнительную инфраструктуру.
